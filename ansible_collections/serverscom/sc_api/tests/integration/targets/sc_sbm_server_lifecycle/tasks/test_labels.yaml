---
- name: Test1 invalid token
  serverscom.sc_api.sc_sbm_server_labels:
    token: invalid
    server_id: '{{ test_sbm_server_id }}'
    labels: {}
  register: test1
  failed_when:
    - test1 is success
    - sc_endpoint not in test1.api_url
    - test1.status_code != 401

- name: Test2, Update labels on non-existing server
  serverscom.sc_api.sc_sbm_server_labels:
    server_id: '{{ non_existing_id }}'
    labels:
      env: test
  register: test2
  ignore_errors: true

- name: Check Test2
  assert:
    that:
      - test2 is not success

- name: Test3, Set labels in check mode
  serverscom.sc_api.sc_sbm_server_labels:
    server_id: '{{ test_sbm_server_id }}'
    labels:
      environment: integration-test
      managed_by: ansible
  check_mode: true
  register: test3

- name: Test3 verify, Get server info to check labels unchanged
  serverscom.sc_api.sc_sbm_server_info:
    server_id: '{{ test_sbm_server_id }}'
  register: test3_verify

- name: Check Test3
  assert:
    that:
      - test3 is changed
      - test3_verify.labels.environment is not defined or test3_verify.labels.environment != 'integration-test'

- name: Test4, Set labels
  serverscom.sc_api.sc_sbm_server_labels:
    server_id: '{{ test_sbm_server_id }}'
    labels:
      environment: integration-test
      managed_by: ansible
  register: test4

- name: Check Test4
  assert:
    that:
      - test4 is changed
      - test4.labels.environment == 'integration-test'
      - test4.labels.managed_by == 'ansible'

- name: Test5, Set same labels (idempotency)
  serverscom.sc_api.sc_sbm_server_labels:
    server_id: '{{ test_sbm_server_id }}'
    labels:
      environment: integration-test
      managed_by: ansible
  register: test5

- name: Check Test5
  assert:
    that:
      - test5 is not changed

- name: Test6, Clear labels
  serverscom.sc_api.sc_sbm_server_labels:
    server_id: '{{ test_sbm_server_id }}'
    labels: {}
  register: test6

- name: Check Test6
  assert:
    that:
      - test6 is changed
      - test6.labels == {}

- name: Test7, Set labels using hostname
  serverscom.sc_api.sc_sbm_server_labels:
    hostname: '{{ test_hostname }}'
    labels:
      hostname_test: passed
  register: test7

- name: Check Test7
  assert:
    that:
      - test7 is changed
      - test7.labels.hostname_test == 'passed'

- name: Test8, Clear labels after hostname test
  serverscom.sc_api.sc_sbm_server_labels:
    server_id: '{{ test_sbm_server_id }}'
    labels: {}
  register: test8

- name: Check Test8
  assert:
    that:
      - test8 is changed

- name: Test9, Verify server_id and hostname are mutually exclusive
  serverscom.sc_api.sc_sbm_server_labels:
    server_id: '{{ test_sbm_server_id }}'
    hostname: '{{ test_hostname }}'
    labels: {}
  register: test9
  ignore_errors: true

- name: Check Test9
  assert:
    that:
      - test9 is failed
